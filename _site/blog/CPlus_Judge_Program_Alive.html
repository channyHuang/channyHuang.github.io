<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=66eb05618adc27639b2de2d6a2ffa04248f96e41">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>channy’s page | Welcome! This is Qianni Huang(qanny, or you can call me channy), a software engineer mainly in Computer Vision, expecially in 3D reconstruction. But this area is too hard to find a job in my city, so I decide to change my area to Linux network coding. This blog is used to write some notes I learned in CV or others.</title>
<meta name="generator" content="Jekyll v3.7.4" />
<meta property="og:title" content="channy’s page" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Welcome! This is Qianni Huang(qanny, or you can call me channy), a software engineer mainly in Computer Vision, expecially in 3D reconstruction. But this area is too hard to find a job in my city, so I decide to change my area to Linux network coding. This blog is used to write some notes I learned in CV or others." />
<meta property="og:description" content="Welcome! This is Qianni Huang(qanny, or you can call me channy), a software engineer mainly in Computer Vision, expecially in 3D reconstruction. But this area is too hard to find a job in my city, so I decide to change my area to Linux network coding. This blog is used to write some notes I learned in CV or others." />
<link rel="canonical" href="http://localhost:4000/blog/CPlus_Judge_Program_Alive.html" />
<meta property="og:url" content="http://localhost:4000/blog/CPlus_Judge_Program_Alive.html" />
<meta property="og:site_name" content="channy’s page" />
<script type="application/ld+json">
{"@type":"WebPage","headline":"channy’s page","url":"http://localhost:4000/blog/CPlus_Judge_Program_Alive.html","description":"Welcome! This is Qianni Huang(qanny, or you can call me channy), a software engineer mainly in Computer Vision, expecially in 3D reconstruction. But this area is too hard to find a job in my city, so I decide to change my area to Linux network coding. This blog is used to write some notes I learned in CV or others.","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <header>
      <div class="container">
        <h1>channy's page</h1>
        <h2>Welcome! This is Qianni Huang(qanny, or you can call me channy), a software engineer mainly in Computer Vision, expecially in 3D reconstruction. But this area is too hard to find a job in my city, so I decide to change my area to Linux network coding. This blog is used to write some notes I learned in CV or others.</h2>

        <section id="downloads">
          
            <a href="http://github.com/qanny/qanny.github.io/zipball/gh-pages" class="btn">Download as .zip</a>
            <a href="http://github.com/qanny/qanny.github.io/tarball/gh-pages" class="btn">Download as .tar.gz</a>
          
          <a href="http://github.com/qanny/qanny.github.io" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <p>//Author: channy</p>

<p>//Create Date: 2019-05-17 15:37:32</p>

<p>//Description: 给定进程名称、启动参数，判断该进程是否正在运行，启动参数不同的不算</p>

<h1 id="cplus_judge_program_alive">CPlus_Judge_Program_Alive</h1>

<p>需求：写一个api判断指定名字和启动参数的进程是否已存在，若不存在则启动。</p>

<blockquote>
  <p>Method 1: 用win的api’ReadProcessMemory’</p>
</blockquote>

<p>实验平台：win 7 64 bit</p>

<p>用’OpenProcess’得到进程句柄，用’ReadProcessMemory’获取地址，第二次调用’ReadProcessMemory’获取参数地址……</p>

<p>结果：。。。当然是失败啦。。。</p>

<p>第一个’ReadProcessMemory’就返回false，然后，就没有然后啦~</p>

<blockquote>
  <p>Method 2: 还是用win的api’DuplicateHandle’</p>
</blockquote>

<p>实验平台：win 7 64 bit; win 10 64 bit</p>

<p>试了一个，好像还是可以的哦，美滋滋。。。</p>

<p>用Qt启动自己写的.exe，QProcess能够设置参数的那种，用下面的代码能够正确判断’由user启动’的进程。在一般情况下够用。</p>

<p>你以为这就完了？Too young too simple^_^</p>

<p>这种方法并不能获取到由system启动的进程的信息，由system启动的如service会在DuplicateHandle的时候返回false，进不到if里面，然后，就获取不到启动参数啦~</p>

<p>然后呢？看到强调的词了吗？当然是要跳过代码到Method3啦</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//need Ntdll.dll in windows
</span><span class="kt">bool</span> <span class="nf">isProgramAlive</span><span class="p">(</span><span class="n">QString</span> <span class="n">sProgramName</span><span class="p">,</span> <span class="n">QString</span> <span class="n">sStartUpParam</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">QStringList</span> <span class="n">qslStartParam</span> <span class="o">=</span> <span class="n">sStartUpParam</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sc">' '</span><span class="p">,</span> <span class="n">QString</span><span class="o">::</span><span class="n">SkipEmptyParts</span><span class="p">);</span>

    <span class="n">HANDLE</span> <span class="n">hSnapshot</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span><span class="n">TH32CS_SNAPPROCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">INVALID_HANDLE_VALUE</span> <span class="o">==</span> <span class="n">hSnapshot</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

    <span class="n">PROCESSENTRY32</span> <span class="n">pe</span><span class="p">;</span>
    <span class="n">pe</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PROCESSENTRY32</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">false</span> <span class="o">==</span> <span class="n">Process32First</span><span class="p">(</span><span class="n">hSnapshot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">do</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">_stricmp</span><span class="p">(</span><span class="n">WcharToChar</span><span class="p">(</span><span class="n">pe</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">).</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">sProgramName</span><span class="p">.</span><span class="n">toStdString</span><span class="p">().</span><span class="n">c_str</span><span class="p">()))</span> <span class="k">continue</span><span class="p">;</span>

        <span class="n">HANDLE</span> <span class="n">hProc</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span><span class="n">PROCESS_ALL_ACCESS</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">pe</span><span class="p">.</span><span class="n">th32ProcessID</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">INVALID_HANDLE_VALUE</span> <span class="o">==</span> <span class="n">hProc</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

        <span class="n">HANDLE</span> <span class="n">hNewProcess</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">PEB</span> <span class="n">peb</span><span class="p">;</span>
        <span class="n">RTL_USER_PROCESS_PARAMETERS</span> <span class="n">upps</span><span class="p">;</span>
        <span class="n">HMODULE</span> <span class="n">hModule</span> <span class="o">=</span> <span class="n">LoadLibrary</span><span class="p">(</span><span class="n">QString</span><span class="p">(</span><span class="s">"Ntdll.dll"</span><span class="p">).</span><span class="n">toStdWString</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
        <span class="k">typedef</span> <span class="n">NTSTATUS</span><span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span><span class="n">NtQueryInformationProcessFace</span><span class="p">)(</span><span class="n">HANDLE</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">,</span> <span class="n">PVOID</span><span class="p">,</span> <span class="n">ULONG</span><span class="p">,</span> <span class="n">PULONG</span><span class="p">);</span>
        <span class="n">NtQueryInformationProcessFace</span> <span class="n">NtQueryInformationProcess</span> <span class="o">=</span> <span class="p">(</span><span class="n">NtQueryInformationProcessFace</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hModule</span><span class="p">,</span> <span class="s">"NtQueryInformationProcess"</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">DuplicateHandle</span><span class="p">(</span><span class="n">GetCurrentProcess</span><span class="p">(),</span> <span class="n">hProc</span><span class="p">,</span> <span class="n">GetCurrentProcess</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">hNewProcess</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">DUPLICATE_SAME_ACCESS</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">PROCESS_BASIC_INFORMATION</span> <span class="n">pbi</span><span class="p">;</span>
            <span class="n">NTSTATUS</span> <span class="n">isok</span> <span class="o">=</span> <span class="n">NtQueryInformationProcess</span><span class="p">(</span><span class="n">hNewProcess</span><span class="p">,</span> <span class="n">ProcessBasicInformation</span><span class="p">,</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pbi</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PROCESS_BASIC_INFORMATION</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">BCRYPT_SUCCESS</span><span class="p">(</span><span class="n">isok</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ReadProcessMemory</span><span class="p">(</span><span class="n">hNewProcess</span><span class="p">,</span> <span class="n">pbi</span><span class="p">.</span><span class="n">PebBaseAddress</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">peb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PEB</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ReadProcessMemory</span><span class="p">(</span><span class="n">hNewProcess</span><span class="p">,</span> <span class="n">peb</span><span class="p">.</span><span class="n">ProcessParameters</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">upps</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">RTL_USER_PROCESS_PARAMETERS</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="p">{</span>
                        <span class="n">WCHAR</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WCHAR</span><span class="p">[</span><span class="n">upps</span><span class="p">.</span><span class="n">CommandLine</span><span class="p">.</span><span class="n">Length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
                        <span class="n">ZeroMemory</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="p">(</span><span class="n">upps</span><span class="p">.</span><span class="n">CommandLine</span><span class="p">.</span><span class="n">Length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">WCHAR</span><span class="p">));</span>
                        <span class="n">ReadProcessMemory</span><span class="p">(</span><span class="n">hNewProcess</span><span class="p">,</span> <span class="n">upps</span><span class="p">.</span><span class="n">CommandLine</span><span class="p">.</span><span class="n">Buffer</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">upps</span><span class="p">.</span><span class="n">CommandLine</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

                        <span class="n">QString</span> <span class="n">qsProcParam</span> <span class="o">=</span> <span class="n">QString</span><span class="o">::</span><span class="n">fromWCharArray</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">upps</span><span class="p">.</span><span class="n">CommandLine</span><span class="p">.</span><span class="n">Length</span><span class="p">).</span><span class="n">toUtf8</span><span class="p">();</span>
                        <span class="k">delete</span> <span class="n">buffer</span><span class="p">;</span>
                        <span class="n">QStringList</span> <span class="n">qslProcParam</span> <span class="o">=</span> <span class="n">qsProcParam</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sc">' '</span><span class="p">,</span> <span class="n">QString</span><span class="o">::</span><span class="n">SkipEmptyParts</span><span class="p">);</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">qslProcParam</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">qslStartParam</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="kt">int</span> <span class="n">nPos</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                            <span class="k">for</span> <span class="p">(</span><span class="n">QString</span> <span class="n">sParam</span> <span class="o">:</span> <span class="n">qslStartParam</span><span class="p">)</span>
                            <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">qslProcParam</span><span class="p">[</span><span class="n">nPos</span><span class="p">]</span> <span class="o">!=</span> <span class="n">sParam</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
                                <span class="n">nPos</span><span class="o">++</span><span class="p">;</span>
                            <span class="p">}</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">nPos</span> <span class="o">==</span> <span class="n">qslProcParam</span><span class="p">.</span><span class="n">size</span><span class="p">())</span>
                                <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hNewProcess</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">qDebug</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">QString</span><span class="o">::</span><span class="n">number</span><span class="p">(</span><span class="n">GetLastError</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProc</span><span class="p">);</span>
    <span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="n">Process32Next</span><span class="p">(</span><span class="n">hSnapshot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe</span><span class="p">));</span>

    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hSnapshot</span><span class="p">);</span>
</code></pre></div></div>

<blockquote>
  <p>Method 3: 用cmd命令，对结果进行分析</p>
</blockquote>

<p>实验平台：win 7 64 bit; win 10 64 bit</p>

<p>cmd运行”wmic process where caption=’进程名字’ get caption,commandline /value”可以获得指定名字的正在运行的进程的启动参数，然后对参数进行分割、判断</p>

<p>在自己的两台机子上跑完全ok，希望在别人的机子上跑不出幺蛾子吧~</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">bool</span> <span class="nf">isProgramAlive</span><span class="p">(</span><span class="n">QString</span> <span class="n">sProgramName</span><span class="p">,</span> <span class="n">QString</span> <span class="n">sStartUpParam</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">QStringList</span> <span class="n">qslStartParam</span> <span class="o">=</span> <span class="n">sStartUpParam</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sc">' '</span><span class="p">,</span> <span class="n">QString</span><span class="o">::</span><span class="n">SkipEmptyParts</span><span class="p">);</span>
    <span class="n">QString</span> <span class="n">sCmdGetProgInfo</span> <span class="o">=</span> <span class="s">"wmic process where caption='"</span> <span class="o">+</span> <span class="n">sProgramName</span> <span class="o">+</span> <span class="s">"' get caption,commandline /value"</span><span class="p">;</span>

    <span class="n">QProcess</span> <span class="n">qpCmdProcess</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">qpCmdProcess</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">sCmdGetProgInfo</span><span class="p">);</span>
    <span class="n">qpCmdProcess</span><span class="p">.</span><span class="n">waitForStarted</span><span class="p">();</span>
    <span class="n">qpCmdProcess</span><span class="p">.</span><span class="n">waitForFinished</span><span class="p">();</span>
    <span class="n">QByteArray</span> <span class="n">qbProgInfo</span> <span class="o">=</span> <span class="n">qpCmdProcess</span><span class="p">.</span><span class="n">readAllStandardOutput</span><span class="p">();</span>

    <span class="c1">//qDebug() &lt;&lt; qpComProcess.readAllStandardError();
</span>    <span class="c1">//qDebug() &lt;&lt; "qbProgInfo " &lt;&lt; qbProgInfo;
</span>    <span class="n">QStringList</span> <span class="n">qslProgInfo</span> <span class="o">=</span> <span class="n">QString</span><span class="p">(</span><span class="n">qbProgInfo</span><span class="p">).</span><span class="n">split</span><span class="p">(</span><span class="n">QRegExp</span><span class="p">(</span><span class="s">"[</span><span class="se">\r</span><span class="s"> </span><span class="se">\n</span><span class="s">]+"</span><span class="p">),</span> <span class="n">QString</span><span class="o">::</span><span class="n">SkipEmptyParts</span><span class="p">);</span>

    <span class="n">QStringList</span> <span class="n">qslProgParam</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">nProgCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">QString</span> <span class="n">sInfo</span> <span class="o">:</span> <span class="n">qslProgInfo</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sInfo</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="s">"Caption"</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">nProgCnt</span><span class="o">++</span><span class="p">;</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sInfo</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="s">"CommandLine"</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">nProgCnt</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
            <span class="c1">//qDebug() &lt;&lt; qslProgParam.size() &lt;&lt; " " &lt;&lt; sInfo &lt;&lt; " " &lt;&lt; qslProgParam;
</span>            <span class="k">if</span> <span class="p">(</span><span class="n">qslProgParam</span> <span class="o">==</span> <span class="n">qslStartParam</span><span class="p">)</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
            <span class="n">qslProgParam</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">qslProgParam</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">sInfo</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">nProgCnt</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//qDebug() &lt;&lt; qslProgParam.size() &lt;&lt; " " &lt;&lt; qslProgParam;
</span>        <span class="k">if</span> <span class="p">(</span><span class="n">qslProgParam</span> <span class="o">==</span> <span class="n">qslStartParam</span><span class="p">)</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><a href="./">back</a></p>


      </section>
    </div>

    
  </body>
</html>
