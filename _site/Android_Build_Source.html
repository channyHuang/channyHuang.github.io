<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=84ac09b8602d6a8196b5d7394b398209d943550f">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>channy’s page | Welcome! This is Qianni Huang(qanny, or you can call me channy), a software engineer mainly in Computer Vision, expecially in 3D reconstruction. But this area is too hard to find a job in my city, so I decide to change my area to Linux network coding. This blog is used to write some notes I learned in CV or others.</title>
<meta name="generator" content="Jekyll v3.7.4" />
<meta property="og:title" content="channy’s page" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Welcome! This is Qianni Huang(qanny, or you can call me channy), a software engineer mainly in Computer Vision, expecially in 3D reconstruction. But this area is too hard to find a job in my city, so I decide to change my area to Linux network coding. This blog is used to write some notes I learned in CV or others." />
<meta property="og:description" content="Welcome! This is Qianni Huang(qanny, or you can call me channy), a software engineer mainly in Computer Vision, expecially in 3D reconstruction. But this area is too hard to find a job in my city, so I decide to change my area to Linux network coding. This blog is used to write some notes I learned in CV or others." />
<link rel="canonical" href="http://localhost:4000/Android_Build_Source.html" />
<meta property="og:url" content="http://localhost:4000/Android_Build_Source.html" />
<meta property="og:site_name" content="channy’s page" />
<script type="application/ld+json">
{"@type":"WebPage","headline":"channy’s page","url":"http://localhost:4000/Android_Build_Source.html","description":"Welcome! This is Qianni Huang(qanny, or you can call me channy), a software engineer mainly in Computer Vision, expecially in 3D reconstruction. But this area is too hard to find a job in my city, so I decide to change my area to Linux network coding. This blog is used to write some notes I learned in CV or others.","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <header>
      <div class="container">
        <h1>channy's page</h1>
        <h2>Welcome! This is Qianni Huang(qanny, or you can call me channy), a software engineer mainly in Computer Vision, expecially in 3D reconstruction. But this area is too hard to find a job in my city, so I decide to change my area to Linux network coding. This blog is used to write some notes I learned in CV or others.</h2>

        <section id="downloads">
          
            <a href="http://github.com/qanny/qanny.github.io/zipball/gh-pages" class="btn">Download as .zip</a>
            <a href="http://github.com/qanny/qanny.github.io/tarball/gh-pages" class="btn">Download as .tar.gz</a>
          
          <a href="http://github.com/qanny/qanny.github.io" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <p>//Author: channy</p>

<p>//Create Date: 2018-10-13 17:16:45</p>

<p>//Description:</p>

<h1 id="android_build_source">Android_Build_Source</h1>

<h2 id="audio">Audio</h2>
<blockquote>
  <p>summarized by others</p>
</blockquote>

<p>l         AudioTrack被new出来，然后set了一堆信息，同时会通过Binder机制调用另外一端的AudioFlinger，得到IAudioTrack对象，通过它和AudioFlinger交互。</p>

<p>l         调用start函数后，会启动一个线程专门做回调处理，代码里边也会有那种数据拷贝的回调，但是JNI层的回调函数实际并没有往里边写数据，大家只要看write就可以了</p>

<p>l         用户一次次得write，那AudioTrack无非就是把数据memcpy到共享buffer中咯</p>

<p>l         可想而知，AudioFlinger那一定有一个线程在memcpy数据到音频设备中去。我们拭目以待</p>

<hr />

<p>l         在AudioTrack中，调用set函数</p>

<p>l         这个函数会通过AudioSystem::getOutput来得到一个output的句柄</p>

<p>l         AS的getOutput会调用AudioPolicyService的getOutput</p>

<p>l         然后我们就没继续讲APS的getOutPut了，而是去看看APS创建的东西</p>

<p>l         发现APS创建的时候会创建一个AudioManagerBase，这个AMB的创建又会调用APS的openOutput。</p>

<p>l         APS的openOutput又会调用AudioFlinger的openOutput</p>

<hr />

<p>环形buffer</p>
<ol>
  <li>写者的使用</li>
</ol>

<p>我们集中到audio_track_cblk_t这个类，来看看写者是如何使用的。写者就是AudioTrack端，在这个类中，叫user</p>

<p>l         framesAvailable，看看是否有空余空间</p>

<p>l         buffer，获得写空间起始地址</p>

<p>l         stepUser，更新user的位置。</p>

<ol>
  <li>读者的使用</li>
</ol>

<p>读者是AF端，在这个类中加server。</p>

<p>l         framesReady，获得可读的位置</p>

<p>l         stepServer，更新读者的位置</p>

<hr />

<p>l         AF创建了一个代表HAL对象的东西</p>

<p>l         APS创建了两个AudioCommandThread，一个用来处理命令，一个用来播放tone。我们还没看。</p>

<p>l         APS同时会创建AudioManagerBase，做为系统默认的音频管理</p>

<p>l         AMB集中管理了策略上面的事情，同时会在AF的openOutput中创建一个混音线程。同时，AMB会更新一些策略上的安排。</p>

<p>另外，我们分析的AMB是Generic的，但不同厂商可以实现自己的策略。例如我可以设置只要有耳机，所有类型声音都从耳机出。</p>

<h2 id="android-build-source-code">Android Build Source Code</h2>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>source build/envsetup.sh
lunch 
emulator
(emulator -logcat D)
(emulator -logcat V)


cd ../framework/base
mmm core/res/
mm -B


make snod


adb logcat -f ./log.txt

</code></pre></div></div>

<p><a href="./">back</a></p>


      </section>
    </div>

    
  </body>
</html>
