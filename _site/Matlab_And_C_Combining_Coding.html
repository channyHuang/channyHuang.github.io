<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=7447a39df6695448d4d7e917d55a726d0489c730">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>channy’s page | Welcome! This is Qianni Huang(qanny, or you can call me channy), a software engineer mainly in Computer Vision, expecially in 3D reconstruction. But this area is too hard to find a job in my city, so I decide to change my area to Linux network coding. This blog is used to write some notes I learned in CV or others.</title>
<meta name="generator" content="Jekyll v3.7.4" />
<meta property="og:title" content="channy’s page" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Welcome! This is Qianni Huang(qanny, or you can call me channy), a software engineer mainly in Computer Vision, expecially in 3D reconstruction. But this area is too hard to find a job in my city, so I decide to change my area to Linux network coding. This blog is used to write some notes I learned in CV or others." />
<meta property="og:description" content="Welcome! This is Qianni Huang(qanny, or you can call me channy), a software engineer mainly in Computer Vision, expecially in 3D reconstruction. But this area is too hard to find a job in my city, so I decide to change my area to Linux network coding. This blog is used to write some notes I learned in CV or others." />
<link rel="canonical" href="http://localhost:4000/Matlab_And_C_Combining_Coding.html" />
<meta property="og:url" content="http://localhost:4000/Matlab_And_C_Combining_Coding.html" />
<meta property="og:site_name" content="channy’s page" />
<script type="application/ld+json">
{"description":"Welcome! This is Qianni Huang(qanny, or you can call me channy), a software engineer mainly in Computer Vision, expecially in 3D reconstruction. But this area is too hard to find a job in my city, so I decide to change my area to Linux network coding. This blog is used to write some notes I learned in CV or others.","@type":"WebPage","url":"http://localhost:4000/Matlab_And_C_Combining_Coding.html","headline":"channy’s page","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <header>
      <div class="container">
        <h1>channy's page</h1>
        <h2>Welcome! This is Qianni Huang(qanny, or you can call me channy), a software engineer mainly in Computer Vision, expecially in 3D reconstruction. But this area is too hard to find a job in my city, so I decide to change my area to Linux network coding. This blog is used to write some notes I learned in CV or others.</h2>

        <section id="downloads">
          
            <a href="http://github.com/qanny/qanny.github.io/zipball/gh-pages" class="btn">Download as .zip</a>
            <a href="http://github.com/qanny/qanny.github.io/tarball/gh-pages" class="btn">Download as .tar.gz</a>
          
          <a href="http://github.com/qanny/qanny.github.io" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <p>//Author: channy</p>

<p>//Create Date: 2018-10-13 13:27:33</p>

<p>//Description:</p>

<h1 id="matlab_and_c_combining_coding">Matlab_And_C_Combining_Coding</h1>

<h2 id="matlab调用c">matlab调用C</h2>

<p>假设已有C文件.h和.cpp，以加法为例：</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#ifndef ADD_H
#define ADD_H
</span> 
<span class="cp">#include &lt;iostream&gt;
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
 
<span class="kt">double</span> <span class="n">add</span><span class="p">(</span><span class="kt">double</span> <span class="n">a</span><span class="p">,</span> <span class="kt">double</span> <span class="n">b</span><span class="p">);</span>
 
<span class="cp">#endif
#include "add.h"
</span> 
<span class="kt">double</span> <span class="nf">add</span><span class="p">(</span><span class="kt">double</span> <span class="n">a</span><span class="p">,</span> <span class="kt">double</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
 <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>需要在.cpp文件上加如下内容：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "mex.h"
</span> 
<span class="cp">#include "add.h"
</span> 
<span class="kt">double</span> <span class="nf">add</span><span class="p">(</span><span class="kt">double</span> <span class="n">a</span><span class="p">,</span> <span class="kt">double</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
 <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// MEX文件接口函数
</span> 
<span class="kt">void</span> <span class="nf">mexFunction</span><span class="p">(</span><span class="kt">int</span> <span class="n">nlhs</span><span class="p">,</span><span class="n">mxArray</span> <span class="o">*</span><span class="n">plhs</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">nrhs</span><span class="p">,</span><span class="k">const</span> <span class="n">mxArray</span> <span class="o">*</span><span class="n">prhs</span><span class="p">[])</span>
 
<span class="p">{</span>
 
    <span class="kt">double</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
 
    <span class="kt">double</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
 
    <span class="n">plhs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mxCreateDoubleMatrix</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mxREAL</span><span class="p">);</span>
 
    <span class="n">a</span> <span class="o">=</span> <span class="n">mxGetPr</span><span class="p">(</span><span class="n">plhs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
 
    <span class="n">b</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">mxGetPr</span><span class="p">(</span><span class="n">prhs</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
 
    <span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">mxGetPr</span><span class="p">(</span><span class="n">prhs</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
 
    <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
 
<span class="p">}</span>

</code></pre></div></div>

<p>最后在matlab中运行 » mex add.cpp 能够把add编译成mex文件，直接调用</p>

<p>解析：mexFunction四个参数的意思为：</p>

<p>nlhs = 1，说明调用语句左手面（lhs－left hand side）有一个变量，即a。</p>

<p>nrhs = 2，说明调用语句右手面（rhs－right hand side）有两个自变量，即b和c。</p>

<p>plhs是一个数组，其内容为指针，该指针指向数据类型mxArray。因为现在左手面只有一个变量，即该数组只有一个指针，plhs[0]指向的结果会赋值给a。</p>

<p>prhs和plhs类似，因为右手面有两个自变量，即该数组有两个指针，prhs[0]指向了b，prhs[1]指向了c。要注意prhs是const的指针数组，即不能改变其指向内容。</p>

<p>因为Matlab最基本的单元为array，无论是什么类型也好，如有double array、 cell array、 struct array……所以a,b,c都是array，b = 1.1便是一个1x1的double array。而在C语言中，Matlab的array使用mxArray类型来表示。所以就不难明白为什么plhs和prhs都是指向mxArray类型的指针数组。</p>

<p>在未涉及具体的计算时，output的值是未知的，是未赋值的。所以在具体的程序中，我们建立一个1x1的实double矩阵（使用 mxCreateDoubleMatrix函数，其返回指向刚建立的mxArray的指针），然后令plhs[0]指向它。接着令指针a指向plhs [0]所指向的mxArray的第一个元素（使用mxGetPr函数，返回指向mxArray的首元素的指针）。同样地，我们把prhs[0]和prhs [1]所指向的元素（即1.1和2.2）取出来赋给b和c。于是我们可以把b和c作自变量传给函数add，得出给果赋给指针a所指向的mxArray中的元素。因为a是指向plhs[0]所指向的mxArray的元素，所以最后作输出时，plhs[0]所指向的mxArray赋值给output，则 output便是已计算好的结果了。</p>

<h2 id="c调用matlab">C调用matlab</h2>

<p>工程目录中加入包含目录和库目录，一般在MATLAb/2014b/extern/include 和 lib/win64/microsoft中</p>

<p>下例中MTest.m文件如下</p>
<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">MTest</span><span class="p">(</span><span class="n">ab</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">ab</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">ab</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="k">end</span>
</code></pre></div></div>
<p>main.cpp文件</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;iostream&gt;
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
 
<span class="c1">//引用Matlab头文件和库文件
</span><span class="cp">#include "engine.h" 
#pragma comment(lib, "libeng.lib")
#pragma comment(lib, "libmx.lib")
#pragma comment(lib, "libmat.lib")
</span> 
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
 <span class="kt">double</span> <span class="n">ab</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
 <span class="n">ab</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">4.5</span><span class="p">;</span>
 <span class="n">ab</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.6</span><span class="p">;</span>
 <span class="kt">double</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
 
 <span class="c1">//启动
</span> <span class="n">Engine</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
 <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ep</span> <span class="o">=</span> <span class="n">engOpen</span><span class="p">(</span><span class="s">"</span><span class="se">\0</span><span class="s">"</span><span class="p">)))</span> <span class="p">{</span>
 <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">Can't start Matlab Engine</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
 <span class="p">}</span>
 <span class="n">engEvalString</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="s">"clear all"</span><span class="p">);</span>
 
 <span class="n">mxArray</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
 <span class="n">a</span> <span class="o">=</span> <span class="n">mxCreateDoubleMatrix</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mxREAL</span><span class="p">);</span>
 <span class="n">result</span> <span class="o">=</span> <span class="n">mxCreateDoubleMatrix</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mxREAL</span><span class="p">);</span>
 <span class="n">memcpy</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">mxGetPr</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">ab</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ab</span><span class="p">));</span>
 <span class="c1">//执行表达式中的命令
</span> <span class="n">engPutVariable</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="s">"a"</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
 
 <span class="n">engEvalString</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="s">"cd F:/mycode/matlabTest/matlabTest"</span><span class="p">);</span>
 <span class="n">engEvalString</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="s">"c = MTest(a)"</span><span class="p">);</span>
 <span class="n">result</span> <span class="o">=</span> <span class="n">engGetVariable</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="s">"c"</span><span class="p">);</span>
 <span class="n">c</span> <span class="o">=</span> <span class="n">mxGetPr</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
 <span class="n">mxDestroyArray</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
 <span class="n">mxDestroyArray</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
 
 <span class="n">printf</span><span class="p">(</span><span class="s">"%f</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">);</span>
 <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"End..."</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
 <span class="c1">//关闭
</span> <span class="n">engEvalString</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="s">"close;"</span><span class="p">);</span>
 <span class="n">engClose</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
 
 <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
 
 
<span class="cm">/*
#include &lt;iostream&gt;
#include &lt;math.h&gt;
#include "engine.h"
using namespace std;
void main()
{
 Engine *ep; //定义Matlab引擎指针。
 if (!(ep = engOpen(NULL))) //测试是否启动Matlab引擎成功。
 {
 cout &lt;&lt; "Can't start Matlab engine!" &lt;&lt; endl;
 exit(1);
 }
 
 //下面是将c++格式数据转换为matlab格式可用数据
 double data[4] = { 1.0, 2.0, 3.0, 4.0 };
 mxArray *Y = mxCreateDoubleMatrix(1, 4, mxREAL);
 
 memcpy(mxGetPr(Y), data, sizeof(data));
 engPutVariable(ep, "Y", Y);
 
 engEvalString(ep, "plot(Y,'o')");    //显示数据
 mxDestroyArray(Y);
 
 engEvalString(ep, "figure");        //开一个新的显示窗口
 
 //////////////////////////////////////////////////////////
 //下面是从matlab格式数据转换为c++格式可用数据
 //    mxArray *filename=NULL;
 //    const char *name="D:/Program Files/MATLAB/R2010b/bin/win32/lena.jpg";
 //    filename=mxCreateString(name);
 //    engPutVariable(ep,"filename",filename);
 
 engEvalString(ep, "X=imread('F:/mycode/meso/data/pic/0001.jpg');");    //在engine中读取一张图片
 engEvalString(ep, "imshow(X)");        //显示图片
 mxArray *X = engGetVariable(ep, "X");    //从engine获得真正的数组X
 
 int ndims = mxGetNumberOfDimensions(X);    //获得这个数组的维数
 cout &lt;&lt; ndims &lt;&lt; endl;
 
 int *dims = new int[ndims];
 memcpy(dims, mxGetDimensions(X), ndims*sizeof(int));    //获得数组每一维的大小
 for (int i = 0; i&lt;ndims; i++)
 {
 cout &lt;&lt; dims[i] &lt;&lt; "  ";
 }
 cout &lt;&lt; endl;
 
//	double *p=(double*)mxGetData(X);    //指向数组X的指针以便能访问数组元素,图像数据量太大，这里就不显示了
//	for (int i=0;i&lt;dims[0];i++) {
//		for (int j=0;j&lt;dims[1];j++)	{
//			cout&lt;&lt;p[i*dims[1]+j]&lt;&lt;"  ";
//		}
//		cout&lt;&lt;endl;
//	}
 
 delete[] dims;
 mxDestroyArray(X);
 
 cout &lt;&lt; "good job." &lt;&lt; endl;
 cin.get();
 engClose(ep); //关闭Matlab引擎。
 
}
*/</span>
</code></pre></div></div>

<p>未证：</p>

<p>mcc -B csharedlib:函数名 文件名</p>

<p>生成一组文件，其中的.dll, .h, .lib</p>

<p>需要调用的.cpp中加入：头文件，库文件</p>

<p>同样用mxArray和memcpy</p>

<h2 id="matlab调用c带cuda">matlab调用C带cuda</h2>

<p>假设已有C文件和CU文件，以向量加法为例：</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#ifndef __ADDVECTORS_H__
#define __ADDVECTORS_H__
</span> 
<span class="k">extern</span> <span class="kt">void</span> <span class="n">addVectors</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span> <span class="n">A</span><span class="p">,</span> <span class="kt">float</span><span class="o">*</span> <span class="n">B</span><span class="p">,</span><span class="kt">float</span><span class="o">*</span> <span class="n">C</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">);</span>
 
<span class="cp">#endif // __ADDVECTORS_H__
# include "AddVectors.h"
</span><span class="c1">//# include &lt;mex.h&gt;
</span> 
<span class="n">__global__</span> <span class="kt">void</span> <span class="nf">addVectorsMask</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span> <span class="n">A</span><span class="p">,</span> <span class="kt">float</span><span class="o">*</span> <span class="n">B</span><span class="p">,</span> <span class="kt">float</span><span class="o">*</span> <span class="n">C</span><span class="p">,</span><span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">&gt;=</span><span class="n">size</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
 
        <span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>
 
 
<span class="kt">void</span> <span class="nf">addVectors</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span> <span class="n">A</span><span class="p">,</span> <span class="kt">float</span><span class="o">*</span> <span class="n">B</span><span class="p">,</span> <span class="kt">float</span><span class="o">*</span> <span class="n">C</span><span class="p">,</span><span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">float</span> <span class="o">*</span><span class="n">devPtrA</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="kt">float</span> <span class="o">*</span><span class="n">devPtrB</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="kt">float</span> <span class="o">*</span><span class="n">devPtrC</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
 
 
        <span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devPtrA</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="o">*</span><span class="n">size</span><span class="p">);</span>
        <span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devPtrB</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="o">*</span><span class="n">size</span><span class="p">);</span>
        <span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devPtrC</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="o">*</span><span class="n">size</span><span class="p">);</span>
 
        <span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">devPtrA</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="o">*</span><span class="n">size</span><span class="p">,</span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
        <span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">devPtrB</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="o">*</span><span class="n">size</span><span class="p">,</span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
 
 
        <span class="n">addVectorsMask</span><span class="o">&lt;&lt;&lt;</span><span class="n">size</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">devPtrA</span><span class="p">,</span><span class="n">devPtrB</span><span class="p">,</span><span class="n">devPtrC</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
 
        <span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="n">devPtrC</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="o">*</span><span class="n">size</span><span class="p">,</span><span class="n">cudaMemcpyDeviceToHost</span><span class="p">);</span>
 
        <span class="n">cudaFree</span><span class="p">(</span><span class="n">devPtrA</span><span class="p">);</span>
        <span class="n">cudaFree</span><span class="p">(</span><span class="n">devPtrB</span><span class="p">);</span>
        <span class="n">cudaFree</span><span class="p">(</span><span class="n">devPtrC</span><span class="p">);</span>
 
<span class="p">}</span>
</code></pre></div></div>

<p>如同调用C类似，mexFunction增加在CPP文件中</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp"># include "mex.h"
# include "AddVectors.h"
</span> 
<span class="kt">void</span> <span class="nf">mexFunction</span><span class="p">(</span><span class="kt">int</span> <span class="n">nlhs</span><span class="p">,</span> <span class="n">mxArray</span> <span class="o">*</span><span class="n">plhs</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">nrhs</span><span class="p">,</span> <span class="k">const</span> <span class="n">mxArray</span> <span class="o">*</span><span class="n">prhs</span><span class="p">[])</span>
<span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">nrhs</span> <span class="o">!=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">mexErrMsgTxt</span><span class="p">(</span><span class="s">"Invaid number of input arguments"</span><span class="p">);</span>
        
        <span class="k">if</span><span class="p">(</span><span class="n">nlhs</span> <span class="o">!=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mexErrMsgTxt</span><span class="p">(</span><span class="s">"Invaid number of outputs "</span><span class="p">);</span>
 
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">mxIsSingle</span><span class="p">(</span><span class="n">prhs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&amp;&amp;!</span><span class="n">mxIsSingle</span><span class="p">(</span><span class="n">prhs</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">mexErrMsgTxt</span><span class="p">(</span><span class="s">"Input vector data type must be single"</span><span class="p">);</span>
 
        <span class="kt">int</span> <span class="n">numRowsA</span><span class="o">=</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">mxGetM</span><span class="p">(</span><span class="n">prhs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="kt">int</span> <span class="n">numColsA</span><span class="o">=</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">mxGetN</span><span class="p">(</span><span class="n">prhs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="kt">int</span> <span class="n">numRowsB</span><span class="o">=</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">mxGetM</span><span class="p">(</span><span class="n">prhs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="kt">int</span> <span class="n">numColsB</span><span class="o">=</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">mxGetN</span><span class="p">(</span><span class="n">prhs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
 
        <span class="k">if</span><span class="p">(</span><span class="n">numRowsA</span> <span class="o">!=</span><span class="n">numRowsB</span> <span class="o">||</span> <span class="n">numColsA</span> <span class="o">!=</span><span class="n">numColsB</span><span class="p">)</span>
                <span class="n">mexErrMsgTxt</span><span class="p">(</span><span class="s">"Invalid size. The size of two vectors must be same"</span><span class="p">);</span>
        
        <span class="kt">int</span> <span class="n">minSize</span><span class="o">=</span><span class="p">(</span><span class="n">numRowsA</span><span class="o">&lt;</span><span class="n">numColsA</span><span class="p">)</span><span class="o">?</span><span class="n">numRowsA</span><span class="o">:</span><span class="n">numColsA</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">maxSize</span><span class="o">=</span><span class="p">(</span><span class="n">numRowsA</span><span class="o">&gt;</span><span class="n">numColsA</span><span class="p">)</span><span class="o">?</span><span class="n">numRowsA</span><span class="o">:</span><span class="n">numColsA</span><span class="p">;</span>
 
        <span class="k">if</span><span class="p">(</span><span class="n">minSize</span> <span class="o">!=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">mexErrMsgTxt</span><span class="p">(</span><span class="s">"Invalid size. The vector must be one dimentional"</span><span class="p">);</span>
 
        <span class="kt">float</span><span class="o">*</span> <span class="n">A</span><span class="o">=</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">)</span><span class="n">mxGetData</span><span class="p">(</span><span class="n">prhs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="kt">float</span><span class="o">*</span> <span class="n">B</span><span class="o">=</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">)</span><span class="n">mxGetData</span><span class="p">(</span><span class="n">prhs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
 
        <span class="n">plhs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">mxCreateNumericMatrix</span><span class="p">(</span><span class="n">numRowsA</span><span class="p">,</span><span class="n">numColsB</span><span class="p">,</span><span class="n">mxSINGLE_CLASS</span><span class="p">,</span><span class="n">mxREAL</span><span class="p">);</span>
        <span class="kt">float</span><span class="o">*</span> <span class="n">C</span><span class="o">=</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">)</span><span class="n">mxGetData</span><span class="p">(</span><span class="n">plhs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
 
        <span class="n">addVectors</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">maxSize</span><span class="p">);</span>
 
 
<span class="p">}</span>
</code></pre></div></div>

<p>在matlab下输入以下命令生成可调用的中间文件（.obj, .mexw64）</p>
<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">system</span><span class="p">(</span><span class="s1">'nvcc -c AddVectors.cu --compiler-options -fPIC'</span><span class="p">);</span>
 
<span class="nb">mex</span> <span class="n">AddVectorsCuda</span><span class="o">.</span><span class="n">cpp</span> <span class="n">AddVectors</span><span class="o">.</span><span class="n">obj</span> <span class="o">-</span><span class="n">lcudart</span> <span class="o">-</span><span class="n">L</span><span class="s1">'C:/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v6.5/lib/x64'</span>
</code></pre></div></div>

<p>调用测试：</p>
<div class="language-matlab highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">];</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">9</span><span class="p">];</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">AddVectorsCuda</span><span class="p">(</span><span class="nb">single</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">single</span><span class="p">(</span><span class="n">b</span><span class="p">));</span>
</code></pre></div></div>

<p><a href="./">back</a></p>


      </section>
    </div>

    
  </body>
</html>
