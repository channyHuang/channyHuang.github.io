---
layout: default
title: 2020-01-18-006_postgres_WAL.md
categories:
- C++
tags:
- C++
---
//Description:

//Create Date: 2020-01-18 23:21:08

//Author: channy

# 006_postgres_WAL

# postgres WAL

```
heap_insert (heapam.c)
	RelationGetBufferForTuple
	RelationPutHeapTuple
	(准备工作，register buffer、data等)
	XLogInsert(RM_HEAP_ID, info)
		GetFullPageWriteInfo
		XLogRecordAssemble (填充WAL头信息)
		XLogInsertRecord
			CopyXLogRecordToWAL (写到缓存)
			(更新LogwrtRqst.Write位置)
	PageSetLSN(page, recptr);
```

//XLogInsert
* 后台定时flush
```
WalWriterMain (walwriter.c, 变量init->信号函数register->环境init->异常处理register->loop)
	XLogBackgroundFlush (xlog.c)
		XLogWrite (write写)
```
* 有insert/update时flush
```
exec_simple_query (postgres.c)
	finish_xact_command 
		CommitTransactionCommand (xact.c)
			CommitTransaction
				RecordTransactionCommit
					XactLogCommitRecord
						XLogInsert (xloginsert.c)
					XLogFlush (xlog.c)
						XLogWrite (写WAL到磁盘)
```

![wal_struct](E:/images/WAL.png)

## 

pg_dump是WAL日志工具

[back](/)

