---
layout: default
title: V-HACD.md
categories:
- Game
tags:
- Game
---
//Description: V-HACD (convex decomposition)

//Create Date: 2021-12-14 11:07:39

//Author: channy

# 概述 

支持输入格式：.off和.obj

| 类 | 方法 | 功能 | 步骤 |
|---|---|---|---|
| VHACD | ComputeACD | 主入口，包括各项子流程 |
| VHACD | AlignMesh | 初始化基本操作 | 模型对齐，体素化
| Volume | Voxelize | 体素化 | 根据比例把mesh转化为体素数据，inside/on/outside surface
| VHACD | VoxelizeMesh | 迭代性体素化以寻找最优dim | 
| VHACD | ComputePrimitiveSet | 把Volume转化成VoxelSet | 基于voxel或tetrahedron
| VHACD | ComputeACD(const Parameters& params) | pca
| VoxelSet | ComputeConvexHull | 基于[ConvexHull](http://code.google.com/p/bullet/issues/detail?id=275)计算ConvexHull | 
| VHACD | ComputeConcavity | 计算误差 |
| VHACD | ComputePreferredCuttingDirection | 计算w (Game Engine Gems 3. 11.10) |
| VHACD | ComputeBestClippingPlane | 分割平面 |  
| VHACD | MergeConvexHulls | 合并ConvexHulls (Game Engine Gems 3. 11.11) | 
| | SimplifyConvexHulls / SimplifyConvexHull | 简化mesh，以不共面的四个顶点组成的四面体为基础，不断增加点 |
|VHACD | ComputeCenterOfMass | 质心 |
| | ComputeBB | BoundingBox |

# 改进思路

**concavity error calculation**

计算concavity error的目的是评估去掉一条边后生成的convex hull相比原模型的“损失”。原论文中表示可以有多种方法追踪这个误差，并使用了原始曲面到新生成曲面的最远距离作为该误差。roblox使用同样的方法。  
为了得到该误差我们需要两方面的信息：
> 原始模型可量化的特征量  
> 去掉该边后的模型生成的精确的convex hull

HACD使用一个三角面片中一系列的采样点来表示原始曲面，这些采样点将被用于在法线方向进行raycast检测，以找到影响convex hull的凹面。从原始曲面到凹面的最长距离即为误差。乍看是一回事，但基于不同的三角面片有不同的采样密度，大三角面片的简单模型会有大量的盲点  
roblox基于网格距离对每个三角面片进行采样，然后使用BB快速过滤。  
继续过滤当前convex hull边界附近的点，raycast。如果误差没有增加，所有返回距离都是0，但一个有问题的convex hull会使得raycasts碰撞  

总结如下：  
**对每个三角面片进行采样，映射到一个特殊的网格**   
**计算convex hull的BB并过滤所有在BB内部的点**  
**raycast检测是否碰撞**  
**最大距离计为concavity error**  
**如果convex hull没有被挤出原始曲面，返回值应该是0**  
**优化，尽早退出**

该方案提供了一个很好的稳定性，但只有在3D convex hull中才占优势。如果convex hull比较平滑，采样点将不会被对齐到2D方向上。

为了解决该问题，roblox使用完全不同的2D error计算过程。

通过比较结果和原始两个convex hull的面积和，如果结果的面积大，表明接近concavity，这时面积差的开方可以作为concavity error。

**convex hull generation**

> 消除大凹面的convex hull依旧会返回concavity error = 0  
> 合并convex hull有时会丢失顶点，形成空洞

HACD使用Quickhull算法，当有点共面/共线时有误差

Quickhull通过合并共面三角面片避免上述问题。然而这种方法不能用于区分原始三角面片。

2D和3D Quickhull

# reference
[V-HACD-SourceCode](https://github.com/kmammou/v-hacd.git)  
[V-HACD](https://books.google.com/books?hl=zh-TW&lr=&id=vHSmCwAAQBAJ&oi=fnd&pg=PA141&ots=5XQPqhR95G&sig=ZSsug_XCP33187qNSREwwNPH7aI#v=onepage&q&f=false)  
[ROHACD](https://blog.roblox.com/2020/07/search-better-convex-decomposition/)